{{define "Template"}}
<!DOCTYPE html>
<html lang="en"> 
<head> 
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <title>{{.Title}}</title>

    <style>
        .styled {
            border: 0;
            line-height: 2.5;
            padding: 0 20px;
            font-size: 1rem;
            text-align: center;
            color: #fff;
            text-shadow: 1px 1px 1px #000;
            border-radius: 10px;
            background-color: rgba(220, 0, 0, 1);
            background-image: linear-gradient(to top left, rgba(0, 0, 0, .2),rgba(0, 0, 0, .2) 30%,rgba(0, 0, 0, 0));
            box-shadow: inset 2px 2px 3px rgba(255, 255, 255, .6), inset -2px -2px 3px rgba(0, 0, 0, .6);
        }

        .styled:hover {
            background-color: rgba(255, 0, 0, 1);
        }

        .styled:active {
            box-shadow: inset -2px -2px 3px rgba(255, 255, 255, .6), inset 2px 2px 3px rgba(0, 0, 0, .6);
        }
    </style>
</head> 

<body>
    <button id="arbitrary-flow" class="favorite styled" type="button">Start Lifecycle</button>




    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.15/lodash.core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.0/d3.js"></script>
    <script src="https://unpkg.com/d3-dag@0.3.3"></script>
   
    <script>
        (function() {
            class LifecycleDag {
                static isValid(data) {
                    let result = { dag: {}, err: null };
                    try {
                        result.dag = d3.dagStratify()(data);
                    } catch(error) {
                        result.err = error;
                    } finally {
                        return result
                    }
                }

                static isConnected(dag) {
                    let result = { roots: [], err: null };
                    if (!dag.connected()) {
                        result.err = "dag is not connected"
                        result.roots = _.map(dag.children, root => { return root.id; });
                    }
                    return result; 
                }

                static depth(dag) {
                    return dag.depth().descendants().sort((a, b) => a.id - b.id).map((n) => n.value + " " + n.id);
                }

                static height(dag) {
                    return dag.height().descendants().sort((a, b) => a.id - b.id).map((n) => n.value + " " + n.id);
                }

                static node(dag, id) {
                    return dag.descendants().filter((n) => n.id === id);
                }
            }

            let route = { home: "http://{{.Route}}", lifecycle: "http://{{.Route}}/lifecycle" }
            console.log(route)
          
            /*
            fetch(route.lifecycle)
                .then((response) => {
                    return response.json();
                })
                .then((json) => {
                    console.log(`external configuration`,json);
                });
            */ 
            
            const data = [
                {
                    id: "start:flow",
                    description: "Start flow button was clicked by user",
                    eventType: "dom",
                    onEvent: "click",
                    selector: "#start-flow",
                },
                {
                    id: "configure:flow",
                    description: "Configure flow",
                    eventType: "app",
                    parentIds: ["start:flow"],
                    handler: "configureFlow",
                    params: { variant: "release" }
                },
                {
                    id: "create:flow",
                    description: "Create flow",
                    eventType: "app",
                    parentIds: ["configure:flow"],
                    handler: "createFlow",
                    params: { variant: "release" }
                },
                {
                    id: "configure:report",
                    description: "Report flow",
                    eventType: "app",
                    parentIds: ["configure:flow"],
                    handler: "configureReport",
                    params: { variant: "release" }
                },
                {
                    id: "publish:configure",
                    description: "Publish Flow Configuration",
                    eventType: "app",
                    parentIds: ["configure:report"],
                    handler: "publishFlowConfiguration",
                    params: { variant: "release" }
                },
                {
                    id: "run:flow",
                    description: "Run flow",
                    eventType: "app",
                    parentIds: ["create:flow"],
                    handler: "runFlow",
                    params: { variant: "release" }
                },
                {
                    id: "completed:flow",
                    description: "Completed flow",
                    eventType: "app",
                    parentIds: ["run:flow"],
                    handler: "completeFlow",
                    params: { variant: "release" }
                },
                {
                    id: "publish:flow",
                    description: "Publish flow",
                    eventType: "app",
                    parentIds: ["completed:flow"],
                    handler: "publishFlow",
                    params: { variant: "release" } 
                }   
            ]

            var { dag, err } = LifecycleDag.isValid(data);
            if (err) {
                console.log(err.message)
            }

            var { roots, err } = LifecycleDag.isConnected(dag);
            if (err) {
                console.log(`multiple roots `, err, roots.join(" "));
            }

            console.log(`dag depth `, LifecycleDag.depth(dag));
            console.log(`dag height `, LifecycleDag.height(dag));

            var [node] = LifecycleDag.node(dag, "configure:report");
            console.log(`dag filter`, node.depth());
            console.log(`dag fiter depth `, LifecycleDag.depth(node));
        
        })();   
    </script>
</body> 
</html> 
{{end}}
